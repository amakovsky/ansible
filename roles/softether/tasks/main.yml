---
- name: check exist softether
  stat:
    path: "{{ softether_bindir }}/{{ softether_srcdir }}"
  changed_when: false
  failed_when: false
  register: softether_available

- name: Install softether pre-requisites via apt
  apt:
    name: build-essential
    state: present

- name: ReInstall softether
  block:
    - name: delete softether folder
      file:
        path: "{{ softether_bindir }}"
        state: absent
        force: true
  when: softether_reinstall

- name: Install softether
  block:
    - name: create softether src folder
      file:
        path: "/tmp/{{item}}"
        state: directory
        mode: 0755
      with_items:
        - "{{ softether_srcdir }}"

    #    - name: Download softether source
    #      get_url:
    #        url: "{{ softether_source_url }}"
    #        dest: /tmp/softether.tar.gz
    #        mode: 0740

    - name: Extract softether
      unarchive:
        src: "{{ softether_source_url }}"
        dest: "/tmp/{{ softether_srcdir }}"
        remote_src: true
        extra_opts: --strip-components=1

    - name: Build softether from tarball
      command: "{{ item }}"
      args:
        chdir: "/tmp/{{ softether_srcdir }}"
      with_items:
        - make i_read_and_agree_the_license_agreement
      notify: restart vpnserver

    - name: move softether to folder
      command: mv /tmp/{{ softether_srcdir }} {{ softether_bindir }}

    - name: Copy  softether config
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: 0775
      with_items: "{{ softether_config }}"
      notify: restart vpnserver

  when: softether_available.stat.exists == false or softether_reinstall

- name: Copy systemd softether config
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0775
  with_items: "{{ softether_template }}"
  notify: restart vpnserver

- name: start vpnserver
  systemd:
    state: started
    name: vpnserver
