---
- name: check exist asterisk
  stat: path=/usr/sbin/asterisk
  changed_when: False
  failed_when: False
  register: asterisk_available

#- debug:
#    msg: "{{ hostvars }}"

- name: Install asterisk pre-requisites via apt
  apt:
    name: "{{item}}"
    state: present
  with_items:
    - build-essential
    - libssl-dev
    - libncurses5-dev
    - libnewt-dev
    - libxml2-dev
    - linux-headers-{{ ansible_kernel }}
    - libsqlite3-dev
    - uuid-dev
    - libjansson-dev

- name: create  user asterisk
  user:
    name: asterisk
    system: yes
    createhome: no

- name: create asterisk folder
  file:
    path: /var/lib/asterisk/phoneprov/
    state: directory
    mode: 0755

- name: Download asterisk source
  get_url:
    url: https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-13-current.tar.gz
    dest: /tmp/asterisk-13-current.tar.gz
    mode: 0740
  when: asterisk_available.stat.exists == false

- name: Extract asterisk
  unarchive:
    src: /tmp/asterisk-13-current.tar.gz
    dest: /tmp
    remote_src: yes
  register: extract
  when: asterisk_available.stat.exists == false



- name: copy menuselect.makeopts file
  copy:
    src: test
    dest: "/tmp/{{ version }}/menuselect.makeopts"
  when: asterisk_available.stat.exists == false

#- name: Install asterisk
#  shell: cd /tmp/{{ version }} && yes | ./contrib/scripts/install_prereq test; \
#         yes | ./contrib/scripts/install_prereq install; \
#         ./configure; \
#         make NOISY_BUILD=yes; \
#         make install; \
#         make config; \
#         make install-logrotate; \
#         make samples
#  when: asterisk_available.stat.exists == false

- name: Build Asterisk from tarball
  command: "{{ item }} chdir=/tmp/{{ version }}"
  with_items:
    - ./configure
    - make NOISY_BUILD=yes
    - make install
    - make config
    - make install-logrotate
    - make samples
  when: asterisk_available.stat.exists == false

#- name: Install asterisk
#  shell: cd /tmp/{{ version }} && ./configure; \
#         make NOISY_BUILD=yes; \
#         make install; \
#         make config; \
#         make install-logrotate; \
#         make samples
#  when: asterisk_available.stat.exists == false

- name: delete default config
  file:
    path: "/etc/asterisk/{{ item }}"
    state: absent
    force: yes
  with_items: "{{ del_config }}"
  notify: restart asterisk

- name: change user and group for asterisk files
  file:
    path: "{{ item }}"
    owner: asterisk
    group: asterisk
    recurse: yes
  with_items: "{{ asterisk_folders }}"
  notify: restart asterisk

- name: change user and group for asterisk config
  file:
    path: /etc/asterisk
    owner: root
    group: asterisk
    recurse: yes
  notify: restart asterisk

- name: asterisk configure global settings.
  lineinfile:
    dest: "/etc/asterisk/asterisk.conf"
    regexp: "^;?{{ item.option }}.+$"
    line: "{{ item.option }} = {{ item.value }}"
    state: "{{ item.state | default('present') }}"
  with_items: "{{ asterisk_global_config_options }}"
  notify: restart asterisk